name: Playwright (Docker)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  test-docker:
    timeout-minutes: 60
    runs-on: blacksmith-4vcpu-ubuntu-2404

    strategy:
      fail-fast: false
      matrix:
        e2e-target: [polkadot-js, evm]

    steps:
    - uses: actions/checkout@v4

    - name: Setup Docker Builder (with layer caching)
      uses: useblacksmith/setup-docker-builder@v1

    - name: Build Docker image
      uses: useblacksmith/build-push-action@v2
      with:
        context: .
        load: true
        tags: chroma-test:latest

    - name: Run Playwright tests
      run: |
        docker run --rm --shm-size=2gb \
          -e E2E_TARGET=${{ matrix.e2e-target }} \
          -v ${{ github.workspace }}/packages/e2e-${{ matrix.e2e-target }}/playwright-report:/app/packages/e2e-${{ matrix.e2e-target }}/playwright-report \
          -v ${{ github.workspace }}/packages/e2e-${{ matrix.e2e-target }}/test-results:/app/packages/e2e-${{ matrix.e2e-target }}/test-results \
          chroma-test

    - uses: actions/upload-artifact@v4
      if: ${{ !cancelled() }}
      with:
        name: playwright-report-docker-${{ matrix.e2e-target }}
        path: packages/e2e-${{ matrix.e2e-target }}/playwright-report/
        retention-days: 30

    - uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: playwright-test-results-docker-${{ matrix.e2e-target }}
        path: packages/e2e-${{ matrix.e2e-target }}/test-results/
        retention-days: 30
